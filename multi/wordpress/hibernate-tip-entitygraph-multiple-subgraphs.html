<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="generator" content="hepek" /><meta name="theme-color" content="#000" /><meta name="mobile-web-app-capable" content="yes" /><title>Hibernate Tip: Create an EntityGraph with multiple SubGraphs</title><link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css" /></head><body><div class="container-fluid"><div class="hidden-print"></div><div><div class="page-header text-center"><h1>Hibernate Tip: Create an EntityGraph with multiple SubGraphs</h1></div><div class="row"><div class="col-lg-2 col-md-2 invisible"></div><div class="col-lg-8 col-md-8"><p><a href="//www.thorben-janssen.com/tips/">Hibernate Tips</a> is a series of posts in which I describe a quick and easy solution for common Hibernate questions. If you have a question for a future Hibernate Tip, please post a comment below. </p>



<div id="toc_container" class="no_bullets"><p class="toc_title">Contents</p><ul class="toc_list"><li><a href="#Question"><span class="toc_number toc_depth_1">1</span> Question:</a></li><li><a href="#Solution"><span class="toc_number toc_depth_1">2</span> Solution:</a><ul><li><a href="#Defining_the_EntityGraph"><span class="toc_number toc_depth_2">2.1</span> Defining the EntityGraph</a><ul><li><a href="#Avoid_Huge_EntityGraphs"><span class="toc_number toc_depth_3">2.1.1</span> Avoid Huge EntityGraphs</a></li></ul></li><li><a href="#Using_the_EntityGraph"><span class="toc_number toc_depth_2">2.2</span> Using the EntityGraph</a></li></ul></li><li><a href="#Learn_more"><span class="toc_number toc_depth_1">3</span> Learn more:</a></li><li><a href="#Hibernate_Tips_Book"><span class="toc_number toc_depth_1">4</span> Hibernate Tips Book</a></li></ul></div>
<h2><span id="Question">Question:</span></h2>



<p>On my tutorial about JPA&#8217;s <em>EntityGraph</em>s, <a href="https://thorben-janssen.com/jpa-21-entity-graph-part-1-named-entity/#comment-28975">Bipin Shrestha asked</a> the following question:</p>



<p>&#8220;Can you show me an example of how to use subgraphs inside subgraphs?&#8221;</p>



<p>Sure, I&#8217;ve updated the <a href="https://thorben-janssen.com/jpa-21-entity-graph-part-1-named-entity/">tutorial</a> to include an example for it, but I also thought that it&#8217;s an interesting topic for a Hibernate Tip.</p>



<!--more-->



<h2><span id="Solution">Solution:</span></h2>



<p>An <em>EntityGraph</em> provides an excellent way to avoid <a href="https://thorben-janssen.com/free-n1_select_course/">n+1 select issues</a> by initializing the required, <a href="https://thorben-janssen.com/entity-mappings-introduction-jpa-fetchtypes/">lazily fetched associations</a>. The definition of the graph is independent of your query and defines which associations Hibernate shall initialize before returning your query results. </p>



<p>Let&#8217;s take a look at an example.</p>



<figure class="wp-block-image"><img width="798" height="903" src="https://thorben-janssen.com/wp-content/uploads/2019/08/class-diagram-2.png" alt="" class="wp-image-22711" srcset="https://thorben-janssen.com/wp-content/uploads/2019/08/class-diagram-2.png 798w, https://thorben-janssen.com/wp-content/uploads/2019/08/class-diagram-2-265x300.png 265w, https://thorben-janssen.com/wp-content/uploads/2019/08/class-diagram-2-768x869.png 768w" sizes="(max-width: 798px) 100vw, 798px" /><figcaption>Class diagram: <em>Author</em>, <em>Book</em>, <em>Publisher</em>, and <em>Employee </em>entity</figcaption></figure>



<p>One or more <em>Author</em>s wrote each <em>Book</em> and it was published by a <em>Publisher</em>. Each <em>Publisher</em> employs one or more <em>Employees</em>.</p>



<p>Let&#8217;s create a <a href="https://thorben-janssen.com/jpql/">JPQL query </a>that returns an <em>Author</em> entity with initialized associations to the <em>Book</em>, <em>Publisher</em>, and <em>Employee</em> entities. </p>



<p>As you can see in the following code snippet, the query itself is simple.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">TypedQuery&lt;Author&gt; q = em.createQuery(&quot;SELECT a FROM Author a WHERE a.id = 100&quot;, Author.class);
Author a = q.getSingleResult();</pre>



<p>What&#8217;s more interesting is the <em>EntityGraph</em> that tells Hibernate to fetch all the associations. </p>



<h3><span id="Defining_the_EntityGraph">Defining the <em>EntityGraph</em></span></h3>



<div class="content-box-gray" style="float: right; width: 260px; text-align: center; margin-left: 10px;">Watch it on YouTube
https://youtu.be/jJl71UsChdM</div><p>There are multiple ways to define an <em>EntityGraph</em>. The JPA specification provides a <a href="https://thorben-janssen.com/jpa-21-entity-graph-part-1-named-entity/">set of annotations</a>, which I will use in this article, and <a href="https://thorben-janssen.com/jpa-21-entity-graph-part-2-define/">an API</a>. In addition to that, Hibernate can also <a href="https://thorben-janssen.com/parse-string-into-entitygraph/">parse a </a><em><a href="https://thorben-janssen.com/parse-string-into-entitygraph/">String </a></em><a href="https://thorben-janssen.com/parse-string-into-entitygraph/">into an </a><em><a href="https://thorben-janssen.com/parse-string-into-entitygraph/">EntityGraph</a></em>.</p>



<p>Ok, let&#8217;s dive into the annotation-based example.</p>



<p>You can use the <em>@NamedEntityGraph</em>, <em>@NamedAttributeNode</em>, and <em>@NamedSubgraph</em> annotations to specify a graph of entities that Hibernate shall fetch from the database. </p>



<pre class="wp-block-preformatted brush: java; gutter: true">@Entity
@NamedEntityGraph(
	name = &quot;graph.AuthorBooksPublisherEmployee&quot;, 
	attributeNodes = @NamedAttributeNode(value = &quot;books&quot;, subgraph = &quot;subgraph.book&quot;), 
	subgraphs = {
		@NamedSubgraph(name = &quot;subgraph.book&quot;, 
					   attributeNodes = @NamedAttributeNode(value = &quot;publisher&quot;, subgraph = &quot;subgraph.publisher&quot;)),
		@NamedSubgraph(name = &quot;subgraph.publisher&quot;, 
					   attributeNodes = @NamedAttributeNode(value = &quot;employees&quot;)) })
public class Author { ... }</pre>



<div class="content-box-gray" style="float: right; width: 260px; text-align: center; margin-left: 10px;">Watch it on YouTube
https://youtu.be/Zs8Dse_Mpyk</div><p>The <em>@NamedEntityGraph </em>annotation defines the root of the graph. It specifies the <a href="https://thorben-janssen.com/entity-mappings-introduction-jpa-fetchtypes/">fetching behavior</a> for the entity returned by a query. In this example,  it does that for the&nbsp;<em>Author</em>&nbsp;entity.</p>



<p>For each <em>@NamedEntityGraph</em>, you can provide an array of <em>@NamedAttributeNode</em> annotations. Each of them references an entity attribute which Hibernate shall fetch from the database. I use it here to fetch the <em>books</em> attribute of the <em>Author</em> entity.</p>



<p>If your <em>@NamedAttributeNode</em> references an associated entity, you also might want to define the fetching behavior for that entity. You can do that by referencing a <em>subgraph</em>. </p>



<p>This subgraph gets defined by a <em>@NamedSubgraph</em> annotation. As you can see in the previous code snippet, that annotation is very similar to a <em>@NamedEntityGraph</em> annotation. It allows you to provide an array of <em>@NamedAttributeNode</em> annotations which can reference additional subgraphs. I use that annotation to create a subgraph for the <em>Book </em>and the <em>Publisher</em> entity.</p>



<h4><span id="Avoid_Huge_EntityGraphs">Avoid Huge <em>EntityGraph</em>s</span></h4>



<p>This approach enables you to create very deep graphs of entities that Hibernate fetches from the database. But you should be very careful about using entity graphs like that. </p>



<p>Each reference entity requires Hibernate to join another database table and to select all database columns mapped by the entity. That can create a huge result set and slow down your database query.</p>



<p>As a rule of thumb, your entity graph should only reference 1-2 other entities. If you need to fetch a bigger graph, you should double-check your query and talk with your DBA about its performance-impact.</p>



<h3><span id="Using_the_EntityGraph">Using the <em>EntityGraph</em></span></h3>



<p>I explained the different ways to use an <em>EntityGraph </em>in more details in my article <a href="https://thorben-janssen.com/jpa-21-entity-graph-part-1-named-entity/">JPA Entity Graphs: How to Define and Use a NamedEntityGraph</a>. So, I keep this explanation short.</p>



<p>If you want to use the defined graph with your query, you need to instantiate an <em>EntityGraph</em> object. You can do that by calling the <em>createEntityGraph</em> method on your <em>EntityManager</em> with the name of the graph.</p>



<p>In the next step, you can <a href="https://thorben-janssen.com/11-jpa-hibernate-query-hints-every-developer-know/">add a hint to your query</a>. The hint adds your graph as a <em>javax.persistence.fetchgraph</em> or <em>javax.persistence.loadgraph</em>.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">EntityGraph&lt;?&gt; graph = em.createEntityGraph(&quot;graph.AuthorBooksPublisherEmployee&quot;);
TypedQuery&lt;Author&gt; q = em.createQuery(&quot;SELECT a FROM Author a WHERE a.id = 100&quot;, Author.class);
q.setHint(&quot;javax.persistence.fetchgraph&quot;, graph);
Author a = q.getSingleResult();</pre>



<p>When you <a href="https://thorben-janssen.com/hibernate-logging-guide/">activate the logging of SQL statements</a> and execute the query, you can see that Hibernate generated a query that joins the <em>Author</em>, <em>BookAuthor</em>, <em>Book</em>, <em>Publisher</em>, and <em>Employee</em> tables and selects the columns mapped by all 4 entities.</p>



<pre class="wp-block-preformatted brush: sql; gutter: true">06:15:56,900 DEBUG [org.hibernate.SQL] - 
    select
        author0_.id as id1_0_0_,
        book2_.id as id1_1_1_,
        publisher3_.id as id1_4_2_,
        employees4_.id as id1_3_3_,
        author0_.firstName as firstNam2_0_0_,
        author0_.lastName as lastName3_0_0_,
        author0_.version as version4_0_0_,
        book2_.publisherid as publishe5_1_1_,
        book2_.publishingDate as publishi2_1_1_,
        book2_.title as title3_1_1_,
        book2_.version as version4_1_1_,
        books1_.authorId as authorId2_2_0__,
        books1_.bookId as bookId1_2_0__,
        publisher3_.name as name2_4_2_,
        publisher3_.version as version3_4_2_,
        employees4_.firstName as firstNam2_3_3_,
        employees4_.lastName as lastName3_3_3_,
        employees4_.publisher_id as publishe5_3_3_,
        employees4_.version as version4_3_3_,
        employees4_.publisher_id as publishe5_3_1__,
        employees4_.id as id1_3_1__ 
    from
        Author author0_ 
    left outer join
        BookAuthor books1_ 
            on author0_.id=books1_.authorId 
    left outer join
        Book book2_ 
            on books1_.bookId=book2_.id 
    left outer join
        Publisher publisher3_ 
            on book2_.publisherid=publisher3_.id 
    left outer join
        Employee employees4_ 
            on publisher3_.id=employees4_.publisher_id 
    where
        author0_.id=100</pre>



<p>This log message clearly shows the downside of huge <em>EntityGraph</em>s. </p>



<p>I added the defined graph to a very simple query. But due to the complex graph definition, Hibernate had to generate a complex SQL query that joins 5 tables and selects 21 columns.</p>



<p>So, better be careful with your graph definitions and make sure to always check the generated SQL statement.</p>







<h2><span id="Learn_more">Learn more:</span></h2>



<p>If you want to learn more about <em>EntityGraph</em>s and Hibernate&#8217;s fetching behavior, you should also read the following articles:</p>



<ul><li><a href="https://thorben-janssen.com/jpa-21-entity-graph-part-1-named-entity/">JPA Entity Graphs: How to Define and Use a NamedEntityGraph</a></li><li><a href="https://thorben-janssen.com/jpa-21-entity-graph-part-2-define/">JPA Entity Graphs: How to Dynamically Define and Use an EntityGraph</a></li><li><a href="https://thorben-janssen.com/5-ways-to-initialize-lazy-relations-and-when-to-use-them/">5 ways to initialize lazy relations and when to use them</a></li><li><a href="https://thorben-janssen.com/entity-mappings-introduction-jpa-fetchtypes/">Entity Mappings: Introduction to JPA FetchTypes</a></li></ul>



&nbsp;<br />
<h2><span id="Hibernate_Tips_Book">Hibernate Tips Book</span></h2><br />
<div><br />
<br />
<img style="float: left; max-width: 150px; margin-right: 10px;" src="/wp-content/uploads/2017/04/HibernateTips3D2.png" /><br />
<div><br />
<br />
Get more recipes like this one in my new book <a href="https://thorben-janssen.com/hibernate-tips-book/?utm_source=BookLaunch&amp;utm_medium=TipPost">Hibernate Tips: More than 70 solutions to common Hibernate problems</a>.<br />
<br />
It gives you more than 70 ready-to-use recipes for topics like basic and advanced mappings, logging, Java 8 support, caching, and statically and dynamically defined queries.<br />
<br />
<a href="https://thorben-janssen.com/hibernate-tips-book/?utm_source=BookLaunch&amp;utm_medium=TipPost">Get it now</a>!<br />
<br />
</div><br />
</div></div><div class="col-lg-2 col-md-2 invisible"></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="https://unpkg.com/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script></body></html>