<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="generator" content="hepek" /><meta name="theme-color" content="#000" /><meta name="mobile-web-app-capable" content="yes" /><title>Entity Lifecycle Model in JPA &amp; Hibernate</title><link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css" /></head><body><div class="container-fluid"><div class="hidden-print"></div><div><div class="page-header text-center"><h1>Entity Lifecycle Model in JPA &amp; Hibernate</h1></div><div class="row"><div class="col-lg-2 col-md-2 invisible"></div><div class="col-lg-8 col-md-8"><p>The entity lifecycle model is one of the <a href="/jpa-for-beginners/">core concepts of JPA</a> and all its implementations. Even though it&#8217;s not directly visible when working with JPA&#8217;s <em>EntityManager</em>, it affects all operations you perform. The different states of the model define how your persistence provider, e.g. Hibernate, handles your entity objects. This includes if it loads it from the database or gets it from an internal cache, if it persists changes and if it removes the entity.</p>



<p>But before we talk about the different lifecycle states, I need to explain a concept called persistence context. </p>



<div id="toc_container" class="no_bullets"><p class="toc_title">Contents</p><ul class="toc_list"><li><a href="#JPA8217s_Persistence_Context"><span class="toc_number toc_depth_1">1</span> JPA&#8217;s Persistence Context</a></li><li><a href="#JPA8217s_4_Lifecycle_States"><span class="toc_number toc_depth_1">2</span> JPA&#8217;s 4 Lifecycle States</a><ul><li><a href="#Transient"><span class="toc_number toc_depth_2">2.1</span> Transient</a></li><li><a href="#Managed"><span class="toc_number toc_depth_2">2.2</span> Managed</a></li><li><a href="#Detached"><span class="toc_number toc_depth_2">2.3</span> Detached</a></li><li><a href="#Reattaching_an_entity"><span class="toc_number toc_depth_2">2.4</span> Reattaching an entity</a></li><li><a href="#Removed"><span class="toc_number toc_depth_2">2.5</span> Removed</a></li></ul></li><li><a href="#Conclusion"><span class="toc_number toc_depth_1">3</span> Conclusion</a></li></ul></div>
<h2><span id="JPA8217s_Persistence_Context">JPA&#8217;s Persistence Context</span></h2>



<p>The persistence context is one of the main concepts in JPA. You can think of it as a set of all entity objects that you used in your current use case. Each of them represents a record in the database. </p>



<p>The specification defines it as follows:</p>



<blockquote class="wp-block-quote"><p>A persistence context is a set of entity instances in which for any persistent entity identity there is a unique entity instance. Within the persistence context, the entity instances and their lifecycle are managed.</p><cite>JPA Specification &#8211; Chapter 03: Entity Operations <br>(<a href="https://github.com/eclipse-ee4j/jpa-api/blob/master/spec/src/main/asciidoc/ch03-entity-operations.adoc">https://github.com/eclipse-ee4j/jpa-api/blob/master/spec/src/main/asciidoc/ch03-entity-operations.adoc</a>)</cite></blockquote>



<p>Based on this definition, we can now talk about the lifecycle model.</p>



<h2><span id="JPA8217s_4_Lifecycle_States">JPA&#8217;s 4 Lifecycle States</span></h2>



<p>The lifecycle model consists of the 4 states <em>transient</em>, <em>managed</em>, <em>removed,</em> and <em>detached</em>. </p>



<figure class="wp-block-image size-large"><img width="1024" height="576" src="https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model-1024x576.png" alt="" class="wp-image-26497" srcset="https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model-1024x576.png 1024w, https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model-300x169.png 300w, https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model-768x432.png 768w, https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model-400x225.png 400w, https://thorben-janssen.com/wp-content/uploads/2020/07/Lifecycle-Model.png 1280w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h3><span id="Transient">Transient</span></h3>



<p>The lifecycle state of a newly instantiated entity object is called <em>transient</em>. The entity hasn&#8217;t been persisted yet, so it doesn&#8217;t represent any database record. </p>



<p>Your persistence context doesn&#8217;t know about your newly instantiate object. Because of that, it doesn&#8217;t automatically perform an SQL INSERT statement or tracks any changes. As long as your entity object is in the lifecycle state <em>transient</em>, you can think of it as a basic Java object without any connection to the database and any JPA-specific functionality. </p>



<pre class="wp-block-preformatted brush: java; gutter: true">Author author = new Author();
author.setFirstName(&quot;Thorben&quot;);
author.setLastName(&quot;Janssen&quot;);</pre>



<p>That changes when you provide it to the <em>EntityManager.find</em> method. The entity object then changes its lifecycle state to <em>managed </em>and gets attached to the current persistence context.</p>



<h3><span id="Managed">Managed</span></h3>



<p>All entity objects attached to the current persistence context are in the lifecycle state <em>managed</em>. That means that your persistence provider, e.g. Hibernate, will detect any changes on the objects and generate the required SQL INSERT or UPDATE statements when it flushes the persistence context.</p>



<p>There are different ways to get an entity to the lifecycle state <em>managed</em>:</p>



<p>1. You can call the <em>EntityManager.persist</em> method with a new entity object.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">Author author = new Author();
author.setFirstName(&quot;Thorben&quot;);
author.setLastName(&quot;Janssen&quot;);
em.persist(author);</pre>



<p>2. You can load an entity object from the database using the <em>EntityManager.find </em>method, a <a href="https://thorben-janssen.com/jpql/">JPQL query</a>, a <em>CriteriaQuery</em>, or a <a href="https://thorben-janssen.com/jpa-native-queries/">native SQL query</a>.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">Author author = em.find(Author.class, 1L);</pre>



<p>3. You can merge a detached entity by calling the <em>EntityManager.merge </em>method or update it by calling the <em>update </em>method on your Hibernate <em>Session</em>.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">em.merge(author);</pre>



<h3><span id="Detached">Detached</span></h3>



<p>An entity that was previously managed but is no longer attached to the current persistence context is in the lifecycle state <em>detached</em>. </p>



<p>An entity gets detached when you close the persistence context. That typically happens after a request got processed. Then the database transaction gets committed, the persistence context gets closed, and the entity object gets returned to the caller. The caller then retrieves an entity object in the lifecycle state <em>detached</em>.</p>



<p>You can also programmatically detach an entity by calling the <em>detach</em> method on the <em>EntityManager</em>. </p>



<pre class="wp-block-preformatted brush: java; gutter: true">em.detach(author);</pre>



<p>There are only very few <a href="/hibernate-performance-tuning-online-training-wst/">performance tuning reasons</a> to detach a managed entity. If you decide to detach an entity, you should first flush the persistence context to avoid losing any pending changes.</p>



<h3><span id="Reattaching_an_entity">Reattaching an entity</span></h3>



<p>You can reattach an entity by calling the&nbsp;<em>update</em>&nbsp;method on your Hibernate&nbsp;<em>Session&nbsp;</em>or the&nbsp;<em>merge&nbsp;</em>method on the&nbsp;<em>EntityManager</em>. There are a few subtle differences between these operations that I explain in great detail in <a href="/persist-save-merge-saveorupdate-whats-difference-one-use">What&#8217;s the difference between persist, save, merge and update? Which one should you use?</a></p>



<p>In both cases, the entity changes its lifecycle state to managed.</p>



<h3><span id="Removed">Removed</span></h3>



<p>When you call the remove method on your <em>EntityManager</em>, the mapped database record doesn&#8217;t get removed immediately. The entity object only changes its lifecycle state to <em>removed</em>. </p>



<p>During the next flush operation, Hibernate will generate an SQL DELETE statement to remove the record from the database table.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">em.remove(author);</pre>



<h2><span id="Conclusion">Conclusion</span></h2>



<p>All entity operations are based on JPA&#8217;s lifecycle model. It consists of 4 states, which define how your persistence provider handles the entity object.</p>



<p>New entities that are not attached to the current persistence context are in the <em>transient </em>state. </p>



<p>If you call the persist method on the EntityManager with a new entity object or read an existing record from the database, the entity object is in the managed state. It&#8217;s connected to the current persistence context. Your persistence context will generate the required SQL INSERT and UPDATE statement to persist the current state of the object.</p>



<p>Entities in the state removed are scheduled for removal. The persistence provider will generate and execute the required SQL DELETE statement during the next flush operation.</p>



<p>If a previously managed entity is no longer associated with an active persistence context, it has the lifecycle state detached. Changes to such an entity object will not be persisted in the database.</p>



<p>If you want to learn more about JPA&#8217;s basic concepts and how to use them to implement your persistence layer, you should enroll in my <a href="https://thorben-janssen.com/jpa-for-beginners/">JPA for Beginners online course</a>.</p></div><div class="col-lg-2 col-md-2 invisible"></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="https://unpkg.com/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script></body></html>