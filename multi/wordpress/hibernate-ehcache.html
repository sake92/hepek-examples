<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="generator" content="hepek" /><meta name="theme-color" content="#000" /><meta name="mobile-web-app-capable" content="yes" /><title>How to use Ehcache as Hibernate’s 2nd Level Cache</title><link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css" /></head><body><div class="container-fluid"><div class="hidden-print"></div><div><div class="page-header text-center"><h1>How to use Ehcache as Hibernate’s 2nd Level Cache</h1></div><div class="row"><div class="col-lg-2 col-md-2 invisible"></div><div class="col-lg-8 col-md-8"><p>Using JPA&#8217;s and Hibernate&#8217;s 2nd level cache can improve the performance of your persistence layer. It acts as a session-independent entity store. Hibernate uses it whenever you call the <em>find</em> method on your <em>EntityManager</em> or traverse an association to fetch a cached entity. Instead of executing a database query, Hibernate gets the entity object from the cache. That&#8217;s a lot faster than executing a query.</p>



<p>If you provide a query for reading data from your database, for example, a <a href="https://thorben-janssen.com/jpql/">JPQL query</a>, your 2nd level cache will not be used. But you can use Hibernate&#8217;s proprietary <a href="https://thorben-janssen.com/hibernate-tips-use-querycache-avoid-additional-queries/">query cache</a> to cache query results.</p>



<div id="toc_container" class="no_bullets"><p class="toc_title">Contents</p><ul class="toc_list"><li><a href="#Activating_the_2nd_Level_Cache"><span class="toc_number toc_depth_1">1</span> Activating the 2nd Level Cache</a></li><li><a href="#A_Quick_Introduction_to_Ehcache"><span class="toc_number toc_depth_1">2</span> A Quick Introduction to Ehcache</a></li><li><a href="#Configuring_Ehcache_as_Hibernate8217s_2nd_Level_Cache"><span class="toc_number toc_depth_1">3</span> Configuring Ehcache as Hibernate&#8217;s 2nd Level Cache</a><ul><li><a href="#Using_Ehcache_2x"><span class="toc_number toc_depth_2">3.1</span> Using Ehcache 2.x</a></li><li><a href="#Configuring_a_Region_Factory"><span class="toc_number toc_depth_2">3.2</span> Configuring a Region Factory</a></li></ul></li><li><a href="#Using_Ehcache_3x"><span class="toc_number toc_depth_1">4</span> Using Ehcache 3.x</a></li><li><a href="#Configuring_Your_Caches"><span class="toc_number toc_depth_1">5</span> Configuring Your Caches</a><ul><li><a href="#Providing_a_Default_Configuration"><span class="toc_number toc_depth_2">5.1</span> Providing a Default Configuration</a></li></ul></li><li><a href="#Conclusion"><span class="toc_number toc_depth_1">6</span> Conclusion</a></li></ul></div>
<h2><span id="Activating_the_2nd_Level_Cache">Activating the 2nd Level Cache</span></h2>



<p>As I explained in great detail in my <a href="/hibernate-performance-tuning-online-training-wst/">Hibernate Performance Tuning Online Training</a>, you activate the 2nd level cache by configuring the <em>shared-cache-mode</em> parameter in your <em>persistence.xml</em>. </p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;persistence&gt;
    &lt;persistence-unit name=&quot;my-persistence-unit&quot;&gt;
        &lt;!--  enable selective 2nd level cache --&gt;
    	&lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;
		
		...
	&lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>



<p>I recommend setting it to <em>ENABLE_SELECTIVE</em> and annotating each entity class you want to cache with <em>@Cacheable</em>.</p>



<pre class="wp-block-preformatted brush: java; gutter: true">@Entity
@Cacheable
public class Author { ... }</pre>



<p>After you&#8217;ve done that, you need to provide a cache implementation. The cache itself is independent of your persistence provider. JPA and Hibernate only define an interface to the 2nd level cache. Because of that, there are various cache implementations available. <a href="https://www.ehcache.org/">Ehcache</a> is one of the most popular ones.</p>



<h2><span id="A_Quick_Introduction_to_Ehcache">A Quick Introduction to Ehcache</span></h2>



<p>Ehcache is a very popular open-source project available under the Apache 2.0 license. It&#8217;s a multi-purpose, highly scalable cache implementation for Java applications. Typical use cases are in-process, application-level caches in single-instance or clustered deployments, out-of-process caches, and Hibernate&#8217;s 2nd level cache. In this article, I will focus on Ehcache as Hibernate&#8217;s 2nd level cache.</p>



<h2><span id="Configuring_Ehcache_as_Hibernate8217s_2nd_Level_Cache">Configuring Ehcache as Hibernate&#8217;s 2nd Level Cache</span></h2>



<p>The required configuration and dependencies to integrate Ehcache with Hibernate depend on the Ehcache version you want to use in your project. Hibernate provides a proprietary integration for the older Ehcache 2.x releases. The newer Ehcache 3.x releases implement the JCache specification. Hibernate provides a generic integration for all caches that implement that specification.</p>



<p>Let&#8217;s take a look at both of them.</p>



<h3><span id="Using_Ehcache_2x">Using Ehcache 2.x</span></h3>



<p>Hibernate&#8217;s <em>hibernate-ehcache</em> module integrates Ehcache 2.x as the 2nd level cache.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;dependency&gt;
	&lt;groupId&gt;org.hibernate&lt;/groupId&gt;
	&lt;artifactId&gt;hibernate-ehcache&lt;/artifactId&gt;
	&lt;version&gt;5.4.15.Final&lt;/version&gt;
&lt;/dependency&gt;</pre>



<h3><span id="Configuring_a_Region_Factory">Configuring a Region Factory</span></h3>



<p>After you&#8217;ve added the dependency, you need to configure a region factory. You can choose between <em>EhCacheRegionFactory </em>and <em>SingletonEhCacheRegionFactory</em>. </p>



<p>The first one configures a <em>CacheManager </em>for each of Hibernate&#8217;s <em>SessionFactory</em> instances. This is recommended when you use multiple Hibernate <em>SessionFactory </em>instances in the same JVM. You can activate it by setting the <em>hibernate.cache.region.factory_class</em> to <em>ehcache</em>.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;property name=&quot;hibernate.cache.region.factory_class&quot; value=&quot;ehcache&quot;/&gt;
</pre>



<p>If you want to share the same <em>CacheManager </em>instance among multiple <em>SessionFactory </em>instances, you need to set that parameter to <em>ehcache-singleton</em>. This will activate the <em>SingletonEhCacheRegionFactory</em>.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;property name=&quot;hibernate.cache.region.factory_class&quot; value=&quot;ehcache-singleton&quot;/&gt;
</pre>



<p>After you’ve done that, you should also configure your cache. I explain the most important configuration parameters at the <a href="#cacheConfig">end of this article</a>.</p>



<h2><span id="Using_Ehcache_3x">Using Ehcache 3.x</span></h2>



<p>Since version 3, Ehcache has been implementing the JCache specification. You can integrate it using Hibernate&#8217;s <em>hibernate-jcache</em> module. It provides a generic integration for all JCache compatible cache implementations.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;dependency&gt;
	&lt;groupId&gt;org.hibernate&lt;/groupId&gt;
	&lt;artifactId&gt;hibernate-jcache&lt;/artifactId&gt;
	&lt;version&gt;5.4.15.Final&lt;/version&gt;
&lt;/dependency&gt;</pre>



<p>In addition to the dependency, you also need to add the <em>hibernate.cache.region.factory_class property</em> to your <em>persistence.xml</em> configuration and set it to <em>jcache</em>.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;property name=&quot;hibernate.cache.region.factory_class&quot; value=&quot;jcache&quot;/&gt;</pre>



<p>Hibernate then uses the default JCache provider to create the default <em>CacheManager</em>. It also uses a default configuration to create the caches. If you want to provide a configuration, which you should, you need to specify the <em>CacheManager </em>and a path to the cache configuration in your <em>persistence.xml</em> file.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;property name=&quot;hibernate.javax.cache.provider&quot; value=&quot;org.ehcache.jsr107.EhcacheCachingProvider&quot;/&gt;
&lt;property name=&quot;hibernate.javax.cache.uri&quot; value=&quot;file:/META-INF/ehcache.xml&quot;/&gt;</pre>



<h2 id="cacheConfig"><span id="Configuring_Your_Caches">Configuring Your Caches</span></h2>



<p>By default, Hibernate stores each entity class an individual region of the 2nd level cache. It uses the fully qualified class name as the region name. Ehcache maps each region to a separate cache. You can configure each one of them in the <em>ehcache.xml</em> file.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;ehcache&gt;
	&lt;cache name=&quot;com.thorben.janssen.Author&quot;
		maxEntriesLocalHeap=&quot;1000&quot; eternal=&quot;false&quot; timeToIdleSeconds=&quot;300&quot; timeToLiveSeconds=&quot;600&quot;&gt;&lt;/cache&gt;
&lt;/ehcache&gt;
</pre>



<p>When you use Ehcache, you need to configure the maximum size of your cache. You can do that by setting the <em>maxEntriesLocalHeap </em>or the <em>maxBytesLocalHeap </em>configuration attribute. In the previous example,  <em>maxEntriesLocalHeap</em> is set at 1000. So, the cache segment <em>com.thorben.janssen.Author</em> will accept up to 1000 <em>Author</em> entity objects.</p>



<p>Depending on your configuration, cache elements can expire. The <em>timeToLiveSeconds </em>attribute defines the maximum time an object stays in the cache. The <em>timetoIdelSeconds </em>configuration attribute specifies the time after which an unused object gets removed. Based on the cache configuration in the previous example, an <em>Author </em>entity expires if it hasn&#8217;t been accessed for 300 seconds or after it stays in the cache for 600 seconds.</p>



<p>When the cache exceeds its configured size, Ehcache removes expired elements. If that doesn&#8217;t clear up enough space, it evicts objects from the cache. By default, it removes the least recently used elements. You can change that policy using the <em>memoryStoreEvictionPolicy</em> configuration attribute.</p>



<h3><span id="Providing_a_Default_Configuration">Providing a Default Configuration</span></h3>



<p>If you don&#8217;t provide a configuration for each region, the region factory will log a warning and create the region itself. You can prevent the warning message by setting the <em>hibernate.cache.ehcache.missing_cache_strategy</em> configuration property for Ehcache 2.x or <em>hibernate.javax.cache.missing_cache_strategy</em> for Ehcache 3.x. You can choose one of the following:</p>



<ul><li><em>fail</em>, to throw an <em>Exception</em> if a cache isn&#8217;t configured,</li><li><em>create-warn</em> (default), to log a warning and to create a new cache, or</li><li><em>create</em>, to create a new cache without logging a warning.</li></ul>



<p>If you decide to not configure your caches explicitly, you should provide a <em>defaultCache </em>configuration. It will be used for each of the dynamically created caches.</p>



<pre class="wp-block-preformatted brush: xml; gutter: true">&lt;ehcache&gt;
	&lt;defaultCache maxEntriesLocalHeap=&quot;1000&quot; eternal=&quot;false&quot; timeToIdleSeconds=&quot;300&quot; timeToLiveSeconds=&quot;600&quot;&gt;
	&lt;/defaultCache&gt;
	&lt;cache name=&quot;com.thorben.janssen.Author&quot; maxEntriesLocalHeap=&quot;1000&quot; eternal=&quot;false&quot; timeToIdleSeconds=&quot;300&quot; timeToLiveSeconds=&quot;600&quot;&gt;&lt;/cache&gt;
&lt;/ehcache&gt;
</pre>



<h2><span id="Conclusion">Conclusion</span></h2>



<p>Ehcache is a popular and highly scalable cache. Hibernate provides two integrations to support Ehcache as its 2nd level cache implementation.</p>



<p>These integrations require almost no configuration. You only need to add the dependency and configure the region factory class to start using Ehcache based on a default configuration. But it&#8217;s best to provide your configuration and specify the size of your cache and if elements can expire. If you adjust these configuration parameters to your application, Ehcache will act as a very efficient 2nd level cache for Hibernate.</p></div><div class="col-lg-2 col-md-2 invisible"></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="https://unpkg.com/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script></body></html>